{% extends "base.html" %}

{% block title %}项目列表 - 项目管理系统{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- 顶部操作栏 -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <!-- 左侧：筛选控件 -->
        <div class="flex gap-3">
            <form action="" method="get" class="inline">
                <input type="hidden" name="show_completed" value="{% if show_completed %}0{% else %}1{% endif %}">
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm font-medium">
                    {% if show_completed %}
                        隐藏已完成
                    {% else %}
                        显示已完成
                    {% endif %}
                </button>
            </form>
            <a
                href="/update_by_date"
                class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors shadow-sm font-medium"
            >
                更新日历
            </a>
        </div>

        <!-- 中间：搜索框 -->
        <div class="flex w-full lg:w-auto">
            <input
                type="text"
                placeholder="搜索项目名称"
                id="search_term"
                class="flex-1 lg:w-80 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
            <button
                id="search_btn"
                class="px-6 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700 transition-colors font-medium"
            >
                搜索
            </button>
        </div>

        <!-- 右侧：创建项目和导出按钮 -->
        <div class="flex gap-3">
            <a
                href="/add_project"
                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-sm font-medium"
            >
                创建项目
            </a>
            <a
                href="/export_projects_to_excel"
                class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-colors shadow-sm font-medium"
            >
                导出信息到 Excel
            </a>
        </div>
    </div>

    <!-- 正常项目区域 -->
    <div class="mb-10">
        <h2 class="text-xl font-bold text-gray-800 mb-4">正常项目</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for project in projects if not (project.days_since_update and project.days_since_update > 30) %}
                {# 提取阶段|前面的关键词 #}
                {% set stage_key = project.stage.split('|')[0] if (project.stage and '|' in project.stage) else project.stage %}
                {# 根据阶段关键词设置卡片背景色 #}
                {% set bg_color = 'bg-blue-50' if stage_key in ['立项中', '已立项']
                                  else 'bg-purple-50' if stage_key == '招投标'
                                  else 'bg-green-50' if stage_key in ['已中标', '已完成']
                                  else 'bg-gray-50' %}
                {# 设置边框色（对应背景色加深一级） #}
                {% set border_color = 'border-blue-100' if stage_key in ['立项中', '已立项']
                                      else 'border-purple-100' if stage_key == '招投标'
                                      else 'border-green-100' if stage_key in ['已中标', '已完成']
                                      else 'border-gray-200' %}
                {# 设置hover阴影色 #}
                {% set hover_shadow = 'hover:shadow-blue-100' if stage_key in ['立项中', '已立项']
                                      else 'hover:shadow-purple-100' if stage_key == '招投标'
                                      else 'hover:shadow-green-100' if stage_key in ['已中标', '已完成']
                                      else 'hover:shadow-gray-200' %}

            <div class="{{ bg_color }} rounded-xl shadow-md {{ border_color }} border hover:shadow-lg {{ hover_shadow }} transition-shadow duration-300 overflow-hidden">
                <div class="p-6 flex flex-col h-full"> <!-- 关键：设置flex和h-full，让内容自适应且按钮固定底部 -->
                    <!-- 项目名称 -->
                    <h3 class="text-lg font-semibold text-gray-900 mb-2 truncate" title="{{ project.name }}">
                        {{ project.name }}
                    </h3>

                    <!-- 项目规模（原表格的规模字段） -->
                    <div class="mb-2 text-gray-700">
                        <span class="text-sm text-gray-500">规模：</span>
                        <span class="font-medium">{{ project.scale | default('未填写', true) }}</span>
                    </div>

                    <!-- 项目阶段（原表格的阶段字段） -->
                    <div class="mb-3 text-gray-700">
                        <span class="text-sm text-gray-500">阶段：</span>
                        <span class="truncate" title="{{ project.stage | default('未填写', true) }}">{{ project.stage | default('未填写', true) }}</span>
                    </div>

                    <!-- 最近更新 - 固定两行高度空间 -->
                    <div class="mb-4 text-gray-700 min-h-[48px]"> <!-- 固定最小高度，确保两行空间 -->
                        <span class="text-sm text-gray-500 block mb-1">最近更新：</span>
                        <p class="text-sm line-clamp-2" style="min-height: 2.5rem;" title="{{ project.update_content | default('暂无更新', true) }}">
                            {{ project.update_content | default('暂无更新', true) }}
                        </p>
                    </div>

                    <!-- 更新日期 -->
                    <div class="text-xs text-gray-500 mb-4">
                        更新日期：{{ project.update_date }}
                    </div>

                    <!-- 操作按钮 - 固定在底部 -->
                    <div class="flex gap-3 mt-auto"> <!-- mt-auto 关键：自动顶到底部 -->
                        <a
                            href="/update_project/{{ project.id }}"
                            class="flex-1 px-4 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition-colors font-medium text-center"
                        >
                            更新
                        </a>
                        <a
                            href="/project_details/{{ project.id }}"
                            class="flex-1 px-4 py-2 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 transition-colors font-medium text-center"
                        >
                            详情
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- 无正常项目提示 -->
{#            {% if projects | selectattr('days_since_update', 'undefined') | list | length == 0 and projects | selectattr('days_since_update', '<=', 30) | list | length == 0 %}#}
{#            <div class="col-span-3 bg-gray-50 rounded-xl border border-gray-200 p-8 text-center">#}
{#                <p class="text-gray-500">暂无正常项目</p>#}
{#            </div>#}
{#            {% endif %}#}
        </div>
    </div>

    <!-- 超期项目区域 -->
    <div>
        <h2 class="text-xl font-bold text-amber-600 mb-4">超期项目（更新超过30天）</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for project in projects if project.days_since_update and project.days_since_update > 30 %}
                {# 提取阶段|前面的关键词 #}
                {% set stage_key = project.stage.split('|')[0] if (project.stage and '|' in project.stage) else project.stage %}
                {# 超期项目在原有背景色基础上叠加琥珀色浅背景 #}
                {% set bg_color = 'bg-amber-50 bg-opacity-80' if stage_key in ['立项中', '已立项']
                                  else 'bg-amber-50 bg-opacity-80' if stage_key == '招投标'
                                  else 'bg-amber-50 bg-opacity-80' if stage_key in ['已中标', '已完成']
                                  else 'bg-amber-50' %}
                {# 设置边框色 #}
                {% set border_color = 'border-amber-200' %}
                {# 设置hover阴影色 #}
                {% set hover_shadow = 'hover:shadow-amber-100' %}

            <div class="{{ bg_color }} rounded-xl shadow-md {{ border_color }} border hover:shadow-lg {{ hover_shadow }} transition-shadow duration-300 overflow-hidden">
                <div class="p-6 flex flex-col h-full"> <!-- 关键：设置flex和h-full -->
                    <!-- 超期标签 -->
                    <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 mb-3">
                        超期 {{ project.days_since_update }} 天
                    </div>

                    <!-- 项目名称 -->
                    <h3 class="text-lg font-semibold text-gray-900 mb-2 truncate" title="{{ project.name }}">
                        {{ project.name }}
                    </h3>

                    <!-- 项目规模 -->
                    <div class="mb-2 text-gray-700">
                        <span class="text-sm text-gray-500">规模：</span>
                        <span class="font-medium">{{ project.scale | default('未填写', true) }}</span>
                    </div>

                    <!-- 项目阶段 -->
                    <div class="mb-3 text-gray-700">
                        <span class="text-sm text-gray-500">阶段：</span>
                        <span class="truncate" title="{{ project.stage | default('未填写', true) }}">{{ project.stage | default('未填写', true) }}</span>
                    </div>

                    <!-- 最近更新 - 固定两行高度空间 -->
                    <div class="mb-4 text-gray-700 min-h-[48px]"> <!-- 固定最小高度 -->
                        <span class="text-sm text-gray-500 block mb-1">最近更新：</span>
                        <p class="text-sm line-clamp-2" style="min-height: 2.5rem;" title="{{ project.update_content | default('暂无更新', true) }}">
                            {{ project.update_content | default('暂无更新', true) }}
                        </p>
                    </div>

                    <!-- 更新日期 -->
                    <div class="text-xs text-gray-500 mb-4">
                        更新日期：{{ project.update_date }}
                    </div>

                    <!-- 操作按钮 - 固定在底部 -->
                    <div class="flex gap-3 mt-auto"> <!-- mt-auto 关键：自动顶到底部 -->
                        <a
                            href="/update_project/{{ project.id }}"
                            class="flex-1 px-4 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition-colors font-medium text-center"
                        >
                            更新
                        </a>
                        <a
                            href="/project_details/{{ project.id }}"
                            class="flex-1 px-4 py-2 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 transition-colors font-medium text-center"
                        >
                            详情
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}

{#            <!-- 无超期项目提示 -->#}
{#            {% if projects | selectattr('days_since_update', '>', 30) | list | length == 0 %}#}
{#            <div class="col-span-3 bg-gray-50 rounded-xl border border-gray-200 p-8 text-center">#}
{#                <p class="text-gray-500">暂无超期项目</p>#}
{#            </div>#}
{#            {% endif %}#}
        </div>
    </div>

    <!-- 分页 -->
    <div class="flex justify-center mt-6">
        <nav class="flex gap-2">
            {% for p in pagination.iter_pages() %}
                {% if p %}
                <a
                    href="/index?page={{ p }}{% if show_completed %}&show_completed=1{% endif %}"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 transition-colors text-sm font-medium {% if p == pagination.page %}bg-blue-600 text-white{% else %}text-gray-700{% endif %}"
                >
                    {{ p }}
                </a>
                {% endif %}
            {% endfor %}
        </nav>
    </div>
</div>

<!-- 搜索按钮JavaScript -->
<script>
    $(document).ready(function() {
        $('#search_btn').click(function(e) {
            e.preventDefault();
            const searchTerm = $('#search_term').val().trim();
            if (searchTerm) {
                window.location.href = '/search_results?search_term=' + encodeURIComponent(searchTerm);
            } else {
                alert('请输入搜索关键词');
            }
        });

        $('#search_term').keypress(function(e) {
            if (e.which == 13) {
                $('#search_btn').click();
            }
        });
    });
</script>
{% endblock %}