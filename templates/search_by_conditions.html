{% extends "base.html" %}

{% block title %}é«˜çº§æœç´¢ - é¡¹ç›®ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">é«˜çº§æœç´¢</h1>
        <p class="mt-2 text-gray-600">ä½¿ç”¨å¤šç§æ¡ä»¶ç²¾ç¡®æŸ¥æ‰¾é¡¹ç›®</p>
    </div>

    <!-- æœç´¢é€‰é¡¹å¡ -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-6">
        <div class="flex border-b border-gray-200">
            <button
                type="button"
                onclick="switchTab('keyword')"
                id="tab-keyword"
                class="flex-1 px-6 py-4 text-center font-medium transition-colors bg-blue-600 text-white"
            >
                ğŸ” å…³é”®å­—æœç´¢
            </button>
            <button
                type="button"
                onclick="switchTab('location')"
                id="tab-location"
                class="flex-1 px-6 py-4 text-center font-medium transition-colors text-gray-600 hover:bg-gray-50"
            >
                ğŸ“ åœ°ç†ä½ç½®æœç´¢
            </button>
            <button
                type="button"
                onclick="switchTab('condition')"
                id="tab-condition"
                class="flex-1 px-6 py-4 text-center font-medium transition-colors text-gray-600 hover:bg-gray-50"
            >
                âš™ï¸ æ¡ä»¶æœç´¢
            </button>
        </div>

        <!-- æœç´¢è¡¨å•åŒºåŸŸ -->
        <div class="p-6">
            <!-- å…³é”®å­—æœç´¢è¡¨å• -->
            <form
                action="/search_by_conditions"
                method="post"
                id="form-keyword"
                class="search-form"
            >
                <input type="hidden" name="search_type" value="keyword">

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- å…³é”®å­— -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            å…³é”®å­—
                        </label>
                        <input
                            type="text"
                            name="keywords"
                            placeholder="è¾“å…¥å…³é”®å­—ï¼ˆå¤šä¸ªå…³é”®å­—ç”¨ç©ºæ ¼åˆ†éš”ï¼‰"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                        <p class="mt-1 text-xs text-gray-500">
                            å°†åœ¨é¡¹ç›®åç§°ã€å®¢æˆ·åç§°ã€æ›´æ–°å†…å®¹ä¸­æœç´¢
                        </p>
                    </div>

                    <!-- æ—¥æœŸèŒƒå›´ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                å¼€å§‹æ—¥æœŸ
                            </label>
                            <input
                                type="date"
                                name="date_from"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ç»“æŸæ—¥æœŸ
                            </label>
                            <input
                                type="date"
                                name="date_to"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button
                        type="submit"
                        class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-md font-medium"
                    >
                        æœç´¢
                    </button>
                </div>
            </form>

            <!-- åœ°ç†ä½ç½®æœç´¢è¡¨å• -->
            <form
                action="/search_by_conditions"
                method="post"
                id="form-location"
                class="search-form hidden"
            >
                <input type="hidden" name="search_type" value="location">

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- çœä»½ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            çœä»½
                        </label>
                        <select
                            name="province"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">é€‰æ‹©çœä»½</option>
                            {% for p in provinces %}
                            <option value="{{ p.province }}">{{ p.province }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- åŸå¸‚ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            åŸå¸‚
                        </label>
                        <input
                            type="text"
                            name="city"
                            placeholder="è¾“å…¥åŸå¸‚åç§°"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>

                    <!-- åŒºå¿ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            åŒºå¿
                        </label>
                        <input
                            type="text"
                            name="district"
                            placeholder="è¾“å…¥åŒºå¿åç§°"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button
                        type="submit"
                        class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-md font-medium"
                    >
                        æœç´¢
                    </button>
                </div>
            </form>

            <!-- æ¡ä»¶æœç´¢è¡¨å• -->
            <form
                action="/search_by_conditions"
                method="post"
                id="form-condition"
                class="search-form hidden"
            >
                <input type="hidden" name="search_type" value="condition">

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- é¡¹ç›®è´Ÿè´£äºº -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é¡¹ç›®è´Ÿè´£äºº
                        </label>
                        <select
                            name="owner"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">å…¨éƒ¨</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- é”€å”®äººå‘˜ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é”€å”®äººå‘˜
                        </label>
                        <select
                            name="sales_person"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">å…¨éƒ¨</option>
                            {% for person in sales_persons %}
                            <option value="{{ person }}">{{ person }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- é¡¹ç›®é˜¶æ®µ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é¡¹ç›®é˜¶æ®µ
                        </label>
                        <select
                            name="stage"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">å…¨éƒ¨</option>
                            <option value="1">ç«‹é¡¹ä¸­</option>
                            <option value="2">å·²ç«‹é¡¹</option>
                            <option value="3">æ‹›æŠ•æ ‡</option>
                            <option value="4">å·²ä¸­æ ‡</option>
                            <option value="5">å·²å®Œæˆ</option>
                            {% for key, value in stages.items() %}
                            <option value="{{ key }}">{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- é¡¹ç›®è§„æ¨¡ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é¡¹ç›®è§„æ¨¡ï¼ˆä¸‡å…ƒï¼‰
                        </label>
                        <select
                            name="amount_range"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">å…¨éƒ¨</option>
                            <option value="0-100">0-100 ä¸‡</option>
                            <option value="100-500">100-500 ä¸‡</option>
                            <option value="500-1000">500-1000 ä¸‡</option>
                            <option value="1000-">1000 ä¸‡ä»¥ä¸Š</option>
                        </select>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button
                        type="submit"
                        class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-md font-medium"
                    >
                        æœç´¢
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- æœç´¢ç»“æœ -->
    {% if search_results %}
    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
            <h2 class="text-white font-bold text-lg">
                æœç´¢ç»“æœ
                <span class="ml-2 text-sm font-normal opacity-90">
                    (å…± {{ search_results|length }} æ¡)
                </span>
            </h2>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">åºå·</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">é¡¹ç›®åç§°</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">å®¢æˆ·åç§°</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">è§„æ¨¡</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">é˜¶æ®µ</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æœ€æ–°æ›´æ–°</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ›´æ–°æ—¥æœŸ</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for result in search_results %}
                    <tr class="hover:bg-blue-50 transition-colors">
                        <td class="px-4 py-4 text-sm font-medium text-gray-900">
                            {{ loop.index }}
                        </td>
                        <td class="px-4 py-4 text-sm">
                            <span class="text-gray-900 font-medium">{{ result.project_name }}</span>
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-600">
                            {{ result.client_name | default('-', true) }}
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-600">
                            {{ result.scale | default('-', true) }}
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-600">
                            {{ result.stage_name | default(result.stage, true) }}
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-600">
                            <span class="truncate block max-w-xs" title="{{ result.update_content | default('æš‚æ— æ›´æ–°', true) }}">
                                {{ result.update_content | default('æš‚æ— æ›´æ–°', true) }}
                            </span>
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-600">
                            {{ result.update_date | default('-', true) }}
                        </td>
                        <td class="px-4 py-4">
                            <div class="flex gap-2">
                                <a
                                    href="/project_details/{{ result.project_id }}"
                                    class="px-3 py-1.5 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 transition-colors font-medium"
                                >
                                    è¯¦æƒ…
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% elif search_results is defined and not search_results %}
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-12 text-center">
        <div class="text-gray-400 text-6xl mb-4">ğŸ”</div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®</h3>
        <p class="text-gray-600">è¯·è°ƒæ•´æœç´¢æ¡ä»¶åé‡è¯•</p>
    </div>
    {% endif %}
</div>

<!-- é€‰é¡¹å¡åˆ‡æ¢è„šæœ¬ -->
<script>
    function switchTab(tabName) {
        // éšè—æ‰€æœ‰è¡¨å•
        document.querySelectorAll('.search-form').forEach(form => {
            form.classList.add('hidden');
        });

        // é‡ç½®æ‰€æœ‰é€‰é¡¹å¡æ ·å¼
        document.querySelectorAll('[id^="tab-"]').forEach(tab => {
            tab.classList.remove('bg-blue-600', 'text-white');
            tab.classList.add('text-gray-600', 'hover:bg-gray-50');
        });

        // æ˜¾ç¤ºé€‰ä¸­çš„è¡¨å•
        document.getElementById('form-' + tabName).classList.remove('hidden');

        // é«˜äº®é€‰ä¸­çš„é€‰é¡¹å¡
        const activeTab = document.getElementById('tab-' + tabName);
        activeTab.classList.remove('text-gray-600', 'hover:bg-gray-50');
        activeTab.classList.add('bg-blue-600', 'text-white');
    }
</script>
{% endblock %}
